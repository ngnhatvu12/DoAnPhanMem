

@{
    ViewData["Title"] = "Quản lý sản phẩm";
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">

<head>
    <title>Danh sách sản phẩm | Quản trị Admin</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Main CSS-->
    <link rel="stylesheet" href="~/css/Admin.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
    <!-- or -->
    <link rel="stylesheet" href="https://unpkg.com/boxicons@latest/css/boxicons.min.css">

    <!-- Font-icon css-->
    <link rel="stylesheet" type="text/css"
          href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">

</head>

<body onload="time()" class="app sidebar-mini rtl">
    <!-- Navbar-->
    <header class="app-header">
        <!-- Sidebar toggle button--><a class="app-sidebar__toggle" href="#" data-toggle="sidebar"
                                        aria-label="Hide Sidebar"></a>
        <!-- Navbar Right Menu-->
        <ul class="app-nav">


            <!-- User Menu-->
            <li>
                <a class="app-nav__item" href="/index.html"><i class='bx bx-log-out bx-rotate-180'></i> </a>

            </li>
        </ul>
    </header>
    <!-- Sidebar menu-->
    <div class="app-sidebar__overlay" data-toggle="sidebar"></div>
    <aside class="app-sidebar">
        <div class="app-sidebar__user">
            <img class="app-sidebar__user-avatar" src="/LayoutOgani/img/hinh1000.jpg" width="50px"
                 alt="User Image">
            <div>
                <p class="app-sidebar__user-name"><b>Ngoc Quyen</b></p>
                <p class="app-sidebar__user-designation">Chào mừng bạn trở lại</p>
            </div>
        </div>
        <hr>
        <ul class="app-menu">
            <li>
                <a class="app-menu__item haha" href="@Url.Action("PosBanHang", "Admin")">
                    <i class='app-menu__icon bx bx-cart-alt'></i>
                    <span class="app-menu__label">POS Bán Hàng</span>
                </a>
            </li>
            <li>
                <a class="app-menu__item " href="@Url.Action("Index", "Admin")">
                    <i class='app-menu__icon bx bx-tachometer'></i><span class="app-menu__label">Bảng điều khiển</span>
                </a>
            </li>
            <li>
                <a class="app-menu__item @((ViewData["Title"] as string) == "Quản lý nhân viên" ? "active" : "")"
                   href="@Url.Action("QuanLyNhanVien", "Admin")">
                    <i class='app-menu__icon bx bx-id-card'></i>
                    <span class="app-menu__label">Quản lý nhân viên</span>
                </a>
            <li>
                <a class="app-menu__item" @((ViewData["Title"] as string) == "Quản lý khách hàng" ? "active" : "")
                   href="@Url.Action("QuanLyKhachHang", "Admin")">
                    <i class='app-menu__icon bx bx-user-voice'></i>
                    <span class="app-menu__label">Quản lý khách hàng</span>
                </a>
            </li>
            <li>
                <a class="app-menu__item active" href="table-data-product.html">
                    <i class='app-menu__icon bx bx-purchase-tag-alt'></i><span class="app-menu__label">Quản lý sản phẩm</span>
                </a>
            </li>
            <li>
                <a class="app-menu__item @((ViewData["Title"] as string) == "Quản lý đơn hàng" ? "active" : "")"
                   asp-controller="Admin" asp-action="QuanLyDonHang">
                    <i class='app-menu__icon bx bx-task'></i><span class="app-menu__label">Quản lý đơn hàng</span>
                </a>
            </li>
            <li>
                <a class="app-menu__item@((ViewData["Title"] as string) == "Quản lý giao hàng" ? "active" : "")"
                   asp-controller="Admin" asp-action="QuanLyGiaoHang">
                    <i class='app-menu__icon bx bx-run'></i><span class="app-menu__label">
                        Quản lý giao hàng
                    </span>
                </a>
            </li>
            <li>
                <a class="app-menu__item@((ViewData["Title"] as string) == "Quản lý giảm giá" ? "active" : "")"
                   asp-controller="Admin" asp-action="QuanLyGiamGia">
                    <i class='app-menu__icon bx bx-dollar'></i><span class="app-menu__label">Quản lý giảm giá</span>
                </a>
            </li>
            <li>
                <a class="app-menu__item@((ViewData["Title"] as string) == "Báo cáo doanh thu" ? "active" : "")"
                   asp-controller="Admin" asp-action="BaoCaoDoanhThu">
                    <i class='app-menu__icon bx bx-pie-chart-alt-2'></i><span class="app-menu__label">Báo cáo doanh thu</span>
                </a>
            </li>
            <li>
                <a class="app-menu__item@((ViewData["Title"] as string) == "Lịch công tác" ? "active" : "")"
                   asp-controller="Admin" asp-action="LichCongTac">
                    <i class='app-menu__icon bx bx-calendar-check'></i><span class="app-menu__label">Lịch công tác </span>
                </a>
            </li>
            <li>
                <a class="app-menu__item" href="#">
                    <i class='app-menu__icon bx bx-cog'></i><span class="app-menu__label">
                        Cài
                        đặt hệ thống
                    </span>
                </a>
            </li>
        </ul>
    </aside>
    <main class="app-content">
        <div class="app-title">
            <ul class="app-breadcrumb breadcrumb side">
                <li class="breadcrumb-item active"><a href="#"><b>Danh sách sản phẩm</b></a></li>
            </ul>
            <div id="clock"></div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="tile">
                    <div class="tile-body">
                        <div class="row element-button">
                            <div class="col-sm-2">

                                <a class="btn btn-add btn-sm" href="#" data-toggle="modal" data-target="#addProductModal" title="Thêm">
                                    <i class="fas fa-plus"></i> Tạo mới sản phẩm
                                </a>
                            </div>
                            <div class="col-sm-2">
                                <a class="btn btn-delete btn-sm nhap-tu-file" type="button" title="Nhập" onclick="myFunction(this)">
                                    <i class="fas fa-file-upload"></i> Tải từ file
                                </a>
                            </div>

                            <div class="col-sm-2">
                                <a class="btn btn-delete btn-sm print-file" type="button" title="In" onclick="myApp.printTable()">
                                    <i class="fas fa-print"></i> In dữ liệu
                                </a>
                            </div>
                            <div class="col-sm-2">
                                <a class="btn btn-delete btn-sm print-file js-textareacopybtn" type="button" title="Sao chép">
                                    <i class="fas fa-copy"></i> Sao chép
                                </a>
                            </div>

                            <div class="col-sm-2">
                                <a class="btn btn-excel btn-sm" href="" title="In"><i class="fas fa-file-excel"></i> Xuất Excel</a>
                            </div>
                            <div class="col-sm-2">
                                <a class="btn btn-delete btn-sm pdf-file" type="button" title="In" onclick="myFunction(this)">
                                    <i class="fas fa-file-pdf"></i> Xuất PDF
                                </a>
                            </div>
                            <div class="col-sm-2">
                                <a class="btn btn-delete btn-sm" type="button" title="Xóa" onclick="myFunction(this)">
                                    <i class="fas fa-trash-alt"></i> Xóa tất cả
                                </a>
                            </div>
                        </div>
                        <table class="table table-hover table-bordered" id="sampleTable">
                            <thead>
                                <tr>
                                    <th width="10"><input type="checkbox" id="all"></th>
                                    <th>Mã sản phẩm</th>
                                    <th>Tên sản phẩm</th>
                                    <th>Ảnh</th>
                                    <th>Số lượng</th>
                                    <th>Tình trạng</th>
                                    <th>Giá tiền</th>
                                    <th>Danh mục</th>
                                    <th>Chức năng</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var product in Model)
                                {
                                    <tr>
                                        <td width="10"><input type="checkbox" name="check1" value="@product.MaSanPham"></td>
                                        <td>@product.MaSanPham</td>
                                        <td>@product.TenSanPham</td>
                                        <td><img src="~/LayoutOgani/img/@product.HinhAnh" alt="" width="100px;"></td>
                                        <td>@product.SoLuong</td>
                                        <td><span class="badge @(product.TinhTrang == "Còn hàng" ? "bg-success" : "bg-danger")">@product.TinhTrang</span></td>
                                        <td>@product.GiaBan.ToString("N0") đ</td>
                                        <td>@product.TenDanhMuc</td>
                                        <td>
                                            <button class="btn btn-primary btn-sm trash" type="button" title="Xóa" onclick="myFunction(this)">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                            <button class="btn btn-primary btn-sm edit" type="button" title="Sửa" data-toggle="modal" data-target="#ModalUP"
                                                    data-masanpham="@product.MaSanPham"
                                                    data-tensanpham="@product.TenSanPham"
                                                    data-mota="@product.MoTa"
                                                    data-giaban="@product.GiaBan"
                                                    data-giagiam="@product.GiaGiam"
                                                    data-loai="@product.TenLoai"
                                                    data-danhmuc="@product.TenDanhMuc">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-info btn-sm details" type="button" title="Chi tiết"
                                                    onclick="showProductReviews('@product.MaSanPham')">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!--
      MODAL
    -->
    <div class="modal fade" id="ModalUP" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="row">
                        <div class="form-group col-md-12">
                            <h5>Chỉnh sửa thông tin sản phẩm cơ bản</h5>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6">
                            <label class="control-label">Mã sản phẩm</label>
                            <input id="editMaSanPham" class="form-control" type="text" readonly>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="control-label">Tên sản phẩm</label>
                            <input id="editTenSanPham" class="form-control" type="text" required>
                        </div>
                        <div class="form-group col-md-12">
                            <label class="control-label">Mô tả</label>
                            <textarea id="editMoTa" class="form-control"></textarea>
                        </div>
                        <div class="form-group col-md-6">
                            <label class="control-label">Giá bán</label>
                            <input id="editGiaBan" class="form-control" type="text">
                        </div>
                        <div class="form-group col-md-6">
                            <label class="control-label">Giá giảm</label>
                            <input id="editGiaGiam" class="form-control" type="text">
                        </div>
                        <div class="form-group col-md-6">
                            <label class="control-label">Loại</label>
                            <input id="editLoai" class="form-control" type="text">
                        </div>
                        <div class="form-group col-md-6">
                            <label class="control-label">Danh mục</label>
                            <input id="editDanhMuc" class="form-control" type="text">
                        </div>
                    </div>
                    <button class="btn btn-secondary" type="button" id="toggleVariantsBtn">Chỉnh sửa các biến thể</button>

                    <!-- Container for Variants -->
                    <div id="variantsContainer" class="mt-4" style="display: none;">
                        <h5>Các biến thể sản phẩm</h5>
                        <div id="variantList">
                            <!-- Variants will be added dynamically here -->
                        </div>
                    </div>
                    <button class="btn btn-save" type="button" onclick="saveChanges()">Lưu lại</button>
                    <button class="btn btn-cancel" data-dismiss="modal">Hủy bỏ</button>
                </div>
            </div>
        </div>
    </div>

    <!--
    MODAL
    -->
    <!-- Essential javascripts for application to work-->
    <script src="/js/jquery-3.2.1.min.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="src/jquery.table2excel.js"></script>
    <script src="/js/main.js"></script>
    <!-- The javascript plugin to display page loading on top-->
    <script src="/Plugin/pace.min.js"></script>
    <!-- Page specific javascripts-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>
    <!-- Data table plugin-->
    <script type="text/javascript" src="/Plugin/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="/Plugin/dataTables.bootstrap.min.js"></script>
    <script type="text/javascript">
        $('#sampleTable').DataTable();
        //Thời Gian
        function time() {
            var today = new Date();
            var weekday = new Array(7);
            weekday[0] = "Chủ Nhật";
            weekday[1] = "Thứ Hai";
            weekday[2] = "Thứ Ba";
            weekday[3] = "Thứ Tư";
            weekday[4] = "Thứ Năm";
            weekday[5] = "Thứ Sáu";
            weekday[6] = "Thứ Bảy";
            var day = weekday[today.getDay()];
            var dd = today.getDate();
            var mm = today.getMonth() + 1;
            var yyyy = today.getFullYear();
            var h = today.getHours();
            var m = today.getMinutes();
            var s = today.getSeconds();
            m = checkTime(m);
            s = checkTime(s);
            nowTime = h + " giờ " + m + " phút " + s + " giây";
            if (dd < 10) {
                dd = '0' + dd
            }
            if (mm < 10) {
                mm = '0' + mm
            }
            today = day + ', ' + dd + '/' + mm + '/' + yyyy;
            tmp = '<span class="date"> ' + today + ' - ' + nowTime +
                '</span>';
            document.getElementById("clock").innerHTML = tmp;
            clocktime = setTimeout("time()", "1000", "Javascript");

            function checkTime(i) {
                if (i < 10) {
                    i = "0" + i;
                }
                return i;
            }
        }
    </script>
    <script>
        function deleteRow(r) {
            var i = r.parentNode.parentNode.rowIndex;
            document.getElementById("myTable").deleteRow(i);
        }
        jQuery(function () {
            jQuery(".trash").click(function () {
                swal({
                    title: "Cảnh báo",
                    text: "Bạn có chắc chắn là muốn xóa sản phẩm này?",
                    buttons: ["Hủy bỏ", "Đồng ý"],
                })
                    .then((willDelete) => {
                        if (willDelete) {
                            swal("Đã xóa thành công.!", {

                            });
                        }
                    });
            });
        });
        oTable = $('#sampleTable').dataTable();
        $('#all').click(function (e) {
            $('#sampleTable tbody :checkbox').prop('checked', $(this).is(':checked'));
            e.stopImmediatePropagation();
        });
    </script>
    <!-- Modal Thêm Sản Phẩm -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Thêm Sản Phẩm Mới</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="form-row">
                            <div class="col-md-6">
                                <label for="MaSanPham">Mã Sản Phẩm</label>
                                <input type="text" id="MaSanPham" name="MaSanPham" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="TenSanPham">Tên Sản Phẩm</label>
                                <input type="text" id="TenSanPham" name="TenSanPham" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="MoTa">Mô Tả</label>
                            <textarea id="MoTa" name="MoTa" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="col-md-6">
                                <label for="GiaBan">Giá Bán</label>
                                <input type="number" id="GiaBan" name="GiaBan" class="form-control" step="0.01">
                            </div>
                            <div class="col-md-6">
                                <label for="GiaGiam">Giá Giảm</label>
                                <input type="number" id="GiaGiam" name="GiaGiam" class="form-control" step="0.01">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-6">
                                <label for="MaDanhMuc">Danh Mục</label>
                                <select id="MaDanhMuc" name="MaDanhMuc" class="form-control">
                                    
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="MaLoai">Loại Sản Phẩm</label>
                                <select id="MaLoai" name="MaLoai" class="form-control">
                                    
                                </select>
                            </div>

                        </div>
                        <div class="form-group">
                            <label for="HinhAnh">Hình Ảnh</label>
                            <input type="file" id="HinhAnh" name="HinhAnh" class="form-control">
                        </div>

                        <!-- Phần Thêm Biến Thể Sản Phẩm -->
                        <h5>Thêm Biến Thể Sản Phẩm</h5>
                        <div id="productVariants">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="addVariant()">+ Thêm biến thể</button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="submitProduct()">Thêm Sản Phẩm</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal hiển thị đánh giá sản phẩm -->
    <div class="modal fade" id="productDetailsModal" tabindex="-1" role="dialog" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailsModalLabel">Chi tiết sản phẩm</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Thông tin chi tiết sản phẩm -->
                    <div id="product-details">
                        <h4 id="product-name"></h4>
                        <p><strong>Danh mục:</strong> <span id="product-category"></span></p>
                        <p><strong>Mô tả:</strong> <span id="product-description"></span></p>
                        <p><strong>Giá bán:</strong> <span id="product-price"></span> đ</p>
                        <p><strong>Giá giảm:</strong> <span id="product-discount"></span> đ</p>
                        <p><strong>Tình trạng:</strong> <span id="product-status"></span></p>
                    </div>
                    <!-- Trung bình điểm và phân bố đánh giá -->
                    <div id="product-rating-summary" class="mb-4">
                        <h5>Trung bình đánh giá</h5>
                        <div class="d-flex align-items-center">
                            <div id="average-stars" style="font-size: 24px;"></div>
                            <span id="average-rating" class="ml-2" style="font-size: 20px;"></span>
                        </div>
                        <ul id="rating-breakdown" class="list-group mt-3">
                            <!-- Dòng sao + số lượng đánh giá -->
                        </ul>
                    </div>
                    <!-- Đánh giá -->
                    <div id="product-reviews">
                        <h5>Đánh giá</h5>
                        <div class="form-group">
                            <label for="filter-stars">Lọc theo số sao:</label>
                            <select id="filter-stars" class="form-control w-25">
                                <option value="">Tất cả</option>
                                <option value="5">5 sao</option>
                                <option value="4">4 sao</option>
                                <option value="3">3 sao</option>
                                <option value="2">2 sao</option>
                                <option value="1">1 sao</option>
                            </select>
                        </div>
                        <ul id="review-list" class="list-group">
                            <!-- Đánh giá sẽ được thêm động -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let variantCount = 0;

        function addVariant() {
            variantCount++;
            const variantHTML = `
                <div id="variant_${variantCount}" class="variant">
                    <h6>Biến thể ${variantCount}</h6>
                    <div class="form-group">
                        <label for="MaChiTietSP_${variantCount}">Mã Chi Tiết SP</label>
                        <input type="text" id="MaChiTietSP_${variantCount}" name="MaChiTietSP" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="SoLuongTon_${variantCount}">Số Lượng Tồn</label>
                        <input type="number" id="SoLuongTon_${variantCount}" name="SoLuongTon" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="MaKichThuoc_${variantCount}">Kích Thước</label>
                        <select id="MaKichThuoc_${variantCount}" name="MaKichThuoc" class="form-control">
        
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="MaMauSac_${variantCount}">Màu Sắc</label>
                        <select id="MaMauSac_${variantCount}" name="MaMauSac" class="form-control">
       
                        </select>
                    </div>
                    <div class="form-group">
                    <label for="HinhAnhBienThe_${variantCount}">Ảnh Biến Thể</label>
                    <input type="file" id="HinhAnhBienThe_${variantCount}" name="HinhAnhBienThe" class="form-control">
                    </div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeVariant(${variantCount})">Xóa biến thể</button>
                </div>
            `;
            document.getElementById("productVariants").insertAdjacentHTML("beforeend", variantHTML);
            loadKichThuocOptions(`#MaKichThuoc_${variantCount}`);
            loadMauSacOptions(`#MaMauSac_${variantCount}`);
        }

        function removeVariant(id) {
            document.getElementById(`variant_${id}`).remove();
        }

        async function submitProduct() {
            // Lấy dữ liệu từ form chính (Sản phẩm)
            const productData = {
                MaSanPham: document.getElementById("MaSanPham").value,
                TenSanPham: document.getElementById("TenSanPham").value,
                MoTa: document.getElementById("MoTa").value,
                GiaBan: parseFloat(document.getElementById("GiaBan").value),
                GiaGiam: parseFloat(document.getElementById("GiaGiam").value),
                MaLoai: document.getElementById("MaLoai").value,
                MaDanhMuc: document.getElementById("MaDanhMuc").value,
                HinhAnh: document.getElementById("HinhAnh").files[0] // Lấy file ảnh
            };

            // Lấy dữ liệu từ các biến thể sản phẩm
            const variants = [];
            document.querySelectorAll(".variant").forEach(variant => {
                variants.push({
                    MaChiTietSP: variant.querySelector("input[name='MaChiTietSP']").value,
                    SoLuongTon: parseInt(variant.querySelector("input[name='SoLuongTon']").value),
                    MaKichThuoc: variant.querySelector("select[name='MaKichThuoc']").value,
                    MaMauSac: variant.querySelector("select[name='MaMauSac']").value,
                    HinhAnhBienThe: variant.querySelector("input[name='HinhAnhBienThe']").files[0] // Lấy file ảnh biến thể
                });
            });

            // Tạo FormData để gửi file cùng dữ liệu
            const formData = new FormData();
            formData.append("MaSanPham", productData.MaSanPham);
            formData.append("TenSanPham", productData.TenSanPham);
            formData.append("MoTa", productData.MoTa);
            formData.append("GiaBan", productData.GiaBan);
            formData.append("GiaGiam", productData.GiaGiam);
            formData.append("MaLoai", productData.MaLoai);
            formData.append("MaDanhMuc", productData.MaDanhMuc);
            formData.append("HinhAnh", productData.HinhAnh);

            // Đính kèm thông tin các biến thể vào formData
            variants.forEach((variant, index) => {
                formData.append(`Variants[${index}].MaChiTietSP`, variant.MaChiTietSP);
                formData.append(`Variants[${index}].SoLuongTon`, variant.SoLuongTon);
                formData.append(`Variants[${index}].MaKichThuoc`, variant.MaKichThuoc);
                formData.append(`Variants[${index}].MaMauSac`, variant.MaMauSac);
                formData.append(`Variants[${index}].HinhAnhBienThe`, variant.HinhAnhBienThe);
            });

            try {
                // Gửi dữ liệu tới controller
                const response = await fetch('/Admin/AddProduct', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    alert("Thêm sản phẩm thành công!");
                    location.reload();
                } else {
                    alert(`Lỗi: ${result.message}`);
                }
            } catch (error) {
                console.error('Lỗi khi gửi dữ liệu:', error);
                alert('Đã xảy ra lỗi khi gửi dữ liệu.');
            }
        }

        function loadLoaiOptions() {
            $.ajax({
                url: '/Admin/GetLoaiList',
                type: 'GET',
                success: function (data) {
                    console.log("Data for Loai:", data); // Kiểm tra dữ liệu trả về

                    var loaiSelect = $('#MaLoai');
                    loaiSelect.empty();
                    // Khởi tạo option mặc định
                    var options = ['<option value="">Chọn Loại Sản Phẩm</option>'];

                    // Sử dụng `map` để tạo ra các `<option>` khớp với tên thuộc tính `maLoai` và `tenLoai`
                    options.push(...data.map(item => `<option value="${item.maLoai}">${item.tenLoai}</option>`));
                    loaiSelect.html(options.join(''));
                },
                error: function (error) {
                    console.error("Lỗi khi tải danh sách loại sản phẩm:", error);
                }
            });
        }



        function loadDanhMucOptions() {
            $.ajax({
                url: '/Admin/GetDanhMucList',
                type: 'GET',
                success: function (data) {
                    console.log("Data for Danh Muc:", data); // Kiểm tra dữ liệu trả về

                    var danhMucSelect = $('#MaDanhMuc');
                    danhMucSelect.empty();
                    // Khởi tạo option mặc định
                    var options = ['<option value="">Chọn Danh Mục</option>'];

                    // Sử dụng `map` để tạo ra các `<option>` khớp với tên thuộc tính `maDanhMuc` và `tenDanhMuc`
                    options.push(...data.map(item => `<option value="${item.maDanhMuc}">${item.tenDanhMuc}</option>`));
                    danhMucSelect.html(options.join(''));
                },
                error: function (error) {
                    console.error("Lỗi khi tải danh sách danh mục:", error);
                }
            });
        }


        function loadKichThuocOptions(targetSelector = '#MaKichThuoc') {
            $.ajax({
                url: '/Admin/GetKichThuocList',
                type: 'GET',
                success: function (data) {
                    console.log("Data for Kich Thuoc:", data); // Kiểm tra dữ liệu trả về

                    var kichThuocSelect = $(targetSelector);
                    kichThuocSelect.empty();
                    // Khởi tạo option mặc định
                    var options = ['<option value="">Chọn Kích Thước</option>'];
                    options.push(...data.map(item => `<option value="${item.maKichThuoc}">${item.tenKichThuoc}</option>`));
                    kichThuocSelect.html(options.join(''));
                },
                error: function (error) {
                    console.error("Lỗi khi tải danh sách kích thước:", error);
                }
            });
        }

        function loadMauSacOptions(targetSelector = '#MaMauSac') {
            $.ajax({
                url: '/Admin/GetMauSacList',
                type: 'GET',
                success: function (data) {
                    console.log("Data for Mau Sac:", data); // Kiểm tra dữ liệu trả về

                    var mauSacSelect = $(targetSelector);
                    mauSacSelect.empty();
                    // Khởi tạo option mặc định
                    var options = ['<option value="">Chọn Màu Sắc</option>'];
                    options.push(...data.map(item => `<option value="${item.maMauSac}">${item.tenMauSac}</option>`));
                    mauSacSelect.html(options.join(''));
                },
                error: function (error) {
                    console.error("Lỗi khi tải danh sách màu sắc:", error);
                }
            });
        }


        $(document).ready(function () {
            loadLoaiOptions();
            loadDanhMucOptions();
            loadKichThuocOptions();
            loadMauSacOptions();
        });

    </script>
    <script>
        $(document).on("click", ".edit", function () {
            const maSanPham = $(this).data("masanpham");

            // Lấy thông tin chi tiết sản phẩm từ server
            $.ajax({
                url: `/Admin/GetProductDetails?maSanPham=${maSanPham}`,
                type: 'GET',
                success: function (data) {
                    // Gán dữ liệu vào các ô input trong modal
                    $("#editMaSanPham").val(data.maSanPham || '');
                    $("#editTenSanPham").val(data.tenSanPham || '');
                    $("#editMoTa").val(data.moTa || '');
                    $("#editGiaBan").val(data.giaBan || '');
                    $("#editGiaGiam").val(data.giaGiam || '');
                    $("#editLoai").val(data.loai || '');
                    $("#editDanhMuc").val(data.danhMuc || '');
                },
                error: function (error) {
                    console.error('Lỗi khi lấy thông tin chi tiết sản phẩm:', error);
                    alert('Không thể lấy thông tin sản phẩm. Vui lòng thử lại sau.');
                }
            });
        });

        async function saveChanges() {
            const productData = {
                MaSanPham: $("#editMaSanPham").val(),
                TenSanPham: $("#editTenSanPham").val(),
                MoTa: $("#editMoTa").val(),
                GiaBan: parseFloat($("#editGiaBan").val()),
                GiaGiam: parseFloat($("#editGiaGiam").val()),
                TenLoai: $("#editLoai").val(),  // Gửi TenLoai thay vì MaLoai
                TenDanhMuc: $("#editDanhMuc").val()  // Gửi TenDanhMuc thay vì MaDanhMuc
            };

            try {
                const response = await fetch('/Admin/UpdateProduct', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                const result = await response.json();
                if (response.ok) {
                    alert("Cập nhật sản phẩm thành công!");
                    location.reload();
                } else {
                    alert(`Lỗi: ${result.message}`);
                }
            } catch (error) {
                console.error('Lỗi khi cập nhật sản phẩm:', error);
                alert('Đã xảy ra lỗi khi cập nhật sản phẩm.');
            }
        }
        let variantsVisible = false;

        document.getElementById("toggleVariantsBtn").addEventListener("click", async function () {
            const productId = $("#editMaSanPham").val();

            if (!variantsVisible) {
                try {
                    // Fetch variants for the product from the server
                    const response = await fetch(`/Admin/GetProductVariants?productId=${productId}`);
                    const variants = await response.json();
                    console.log("Fetched variants:", variants);
                    // Clear existing variant list
                    document.getElementById("variantList").innerHTML = "";

                    // Add variants dynamically
                    variants.forEach(variant => {
                        document.getElementById("variantList").insertAdjacentHTML('beforeend', `
                            <div class="variant-item" data-macchitiet="${variant.MaChiTietSP}">
                                <h6>Biến thể: ${variant.MaChiTietSP}</h6>
                                <div class="form-group">
                                    <label>Số lượng tồn</label>
                                    <input type="number" class="form-control variantQuantity" value="${variant.SoLuongTon}" data-macchitiet="${variant.MaChiTietSP}">
                                </div>
                                <div class="form-group">
                                    <label>Trạng thái</label>
                                    <input type="text" class="form-control" value="${variant.SoLuongTon > 0 ? 'Còn hàng' : 'Hết hàng'}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Kích thước</label>
                                    <input type="text" class="form-control variantSize" value="${variant.TenKichThuoc}" data-macchitiet="${variant.MaChiTietSP}">
                                </div>
                                <div class="form-group">
                                    <label>Màu sắc</label>
                                    <input type="text" class="form-control variantColor" value="${variant.TenMauSac}" data-macchitiet="${variant.MaChiTietSP}">
                                </div>
                            </div>
                        `);
                    });

                    // Show variants container
                    document.getElementById("variantsContainer").style.display = "block";
                    variantsVisible = true;
                } catch (error) {
                    console.error("Error fetching variants:", error);
                    alert("Lỗi khi tải các biến thể sản phẩm.");
                }
            } else {
                // Hide variants container if it's already shown
                document.getElementById("variantsContainer").style.display = "none";
                variantsVisible = false;
            }
        });

        // Save function with variant support
        async function saveChanges() {
            const productData = {
                MaSanPham: $("#editMaSanPham").val(),
                TenSanPham: $("#editTenSanPham").val(),
                MoTa: $("#editMoTa").val(),
                GiaBan: parseFloat($("#editGiaBan").val()),
                GiaGiam: parseFloat($("#editGiaGiam").val()),
                TenLoai: $("#editLoai").val(),
                TenDanhMuc: $("#editDanhMuc").val()
            };

            // Gather variant data if visible
            const variants = [];
            if (variantsVisible) {
                document.querySelectorAll(".variant-item").forEach(variant => {
                    variants.push({
                        MaChiTietSP: variant.dataset.macchitiet,
                        SoLuongTon: parseInt(variant.querySelector(".variantQuantity").value),
                        TenKichThuoc: variant.querySelector(".variantSize").value,
                        TenMauSac: variant.querySelector(".variantColor").value
                    });
                });
            }

            try {
                const response = await fetch('/Admin/UpdateProductWithVariants', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productData, variants })
                });
                const result = await response.json();
                if (response.ok) {
                    alert("Cập nhật sản phẩm thành công!");
                    location.reload();
                } else {
                    alert(`Lỗi: ${result.message}`);
                }
            } catch (error) {
                console.error('Lỗi khi cập nhật sản phẩm:', error);
                alert('Đã xảy ra lỗi khi cập nhật sản phẩm.');
            }
        }
        function loadVariants(productId) {
            $.ajax({
                url: `/Admin/GetProductVariants?productId=${productId}`,
                method: 'GET',
                success: function (data) {
                    console.log("Received variants data:", data);
                    renderVariants(data);
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching variants:", error);
                }
            });
        }
        function showProductReviews(maSanPham) {
            $.get(`/Admin/GetProductReviews?maSanPham=${maSanPham}`, function (response) {
                if (response.success) {
                    const product = response.product || {};
                    const reviews = response.danhGia || [];

                    // Hiển thị thông tin sản phẩm
                    $('#product-name').text(product.tenSanPham || 'Không xác định');
                    $('#product-category').text(product.tenDanhMuc || 'Không xác định');
                    $('#product-description').text(product.moTa || 'Không có mô tả');
                    $('#product-price').text(product.giaBan ? `${product.giaBan.toLocaleString()} đ` : 'Không có giá');
                    $('#product-discount').text(product.giaGiam ? `${product.giaGiam.toLocaleString()} đ` : 'Không giảm giá');
                    $('#product-status').text(product.tinhTrang || 'Không xác định');

                    // Tính trung bình điểm và phân bố số sao
                    const totalReviews = reviews.length;
                    const totalScore = reviews.reduce((sum, review) => sum + (review.soDiem || 0), 0);
                    const averageScore = totalReviews > 0 ? (totalScore / totalReviews).toFixed(1) : 0;

                    // Hiển thị trung bình điểm
                    const fullStars = Math.floor(averageScore);
                    const halfStar = averageScore % 1 >= 0.5;
                    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

                    const starHtml = '★'.repeat(fullStars) +
                        (halfStar ? '½' : '') +
                        '☆'.repeat(emptyStars);
                    $('#average-stars').html(starHtml);
                    $('#average-rating').text(`${averageScore} / 5`);

                    // Tạo phân bố số sao
                    const ratingBreakdown = [0, 0, 0, 0, 0];
                    reviews.forEach(review => {
                        if (review.soDiem) ratingBreakdown[5 - review.soDiem]++;
                    });

                    const breakdownHtml = ratingBreakdown.map((count, index) => {
                        const stars = '★'.repeat(5 - index) + '☆'.repeat(index);
                        return `<li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>${stars}</span>
                                    <span>${count}</span>
                                </li>`;
                    }).join('');
                    $('#rating-breakdown').html(breakdownHtml);

                    // Hiển thị danh sách đánh giá
                    function renderReviews(filterStars) {
                        const filteredReviews = filterStars
                            ? reviews.filter(review => review.soDiem === parseInt(filterStars))
                            : reviews;

                        const reviewHtml = filteredReviews.length > 0
                            ? filteredReviews.map(review => {
                                const stars = '★'.repeat(review.soDiem || 0) + '☆'.repeat(5 - (review.soDiem || 0));
                                return `
                                    <li class="list-group-item">
                                        <p><strong>${review.tenKhachHang || 'Ẩn danh'}</strong> - ${stars}</p>
                                        <p>${review.binhLuan || 'Không có bình luận'}</p>
                                        <p><small>${review.ngayDanhGia ? new Date(review.ngayDanhGia).toLocaleDateString('vi-VN') : 'Không rõ ngày'}</small></p>
                                        <button class="btn btn-danger btn-sm" onclick="deleteReview('${review.maDanhGia}')">Xóa</button>
                                    </li>
                                `;
                            }).join('')
                            : '<li class="list-group-item">Không có đánh giá nào.</li>';

                        $('#review-list').html(reviewHtml);
                    }

                    // Render tất cả đánh giá ban đầu
                    renderReviews();

                    // Lọc đánh giá theo số sao
                    $('#filter-stars').off('change').on('change', function () {
                        const filterStars = $(this).val();
                        renderReviews(filterStars);
                    });

                    // Hiển thị modal
                    $('#productDetailsModal').modal('show');
                } else {
                    alert(response.message);
                }
            }).fail(function () {
                alert('Lỗi khi lấy dữ liệu. Vui lòng thử lại.');
            });
        }

        function deleteReview(maDanhGia) {
            if (confirm('Bạn có chắc chắn muốn xóa đánh giá này?')) {
                $.post('/Admin/DeleteReview', { maDanhGia }, function (response) {
                    if (response.success) {
                        alert('Xóa đánh giá thành công!');
                        $('#productDetailsModal').modal('hide'); // Ẩn modal sau khi xóa
                    } else {
                        alert(response.message);
                    }
                });
            }
        }
        // Hiển thị ngôi sao đẹp hơn
function renderStars(averageScore) {
    const fullStars = Math.floor(averageScore);
    const hasHalfStar = averageScore % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

    let starsHtml = '';
    for (let i = 0; i < fullStars; i++) {
        starsHtml += '<i class="star">★</i>';
    }
    if (hasHalfStar) {
        starsHtml += '<i class="half-star">★</i>';
    }
    for (let i = 0; i < emptyStars; i++) {
        starsHtml += '<i class="star empty-star">☆</i>';
    }
    return starsHtml;
}

// Cập nhật hiển thị trong hàm `showProductReviews`
$('#average-stars').html(renderStars(averageScore));

    </script>
</body>
</html>
<style>
    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }

        .form-row .col-md-6 {
            flex: 1;
        }

    #addProductForm .form-group {
        margin-bottom: 15px;
    }

</style>
    <style>
        /* Cân chỉnh modal */
#productDetailsModal .modal-content {
    border-radius: 10px;
    border: none;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

#productDetailsModal .modal-header {
    background-color: #343a40;
    color: #ffffff;
    border-bottom: none;
    border-radius: 10px 10px 0 0;
}

#productDetailsModal .modal-title {
    font-size: 1.5rem;
    font-weight: bold;
}

#productDetailsModal .close {
    color: #ffffff;
    opacity: 0.8;
}

#productDetailsModal .modal-body {
    padding: 20px;
    font-size: 1rem;
    color: #333;
}

/* Thông tin sản phẩm */
#product-details h4 {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 10px;
    color: #007bff;
}

#product-details p {
    margin: 5px 0;
    line-height: 1.6;
}

#product-details strong {
    color: #495057;
}

/* Trung bình đánh giá */
#product-rating-summary h5 {
    font-size: 1.3rem;
    margin-bottom: 10px;
    color: #28a745;
}

#average-stars {
    display: flex;
    align-items: center;
}

#average-stars .star {
    font-size: 1.8rem;
    color: #ffc107;
    margin-right: 2px;
}

#average-stars .half-star {
    background: linear-gradient(90deg, #ffc107 50%, #e4e5e9 50%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 1.8rem;
    margin-right: 2px;
}

#average-rating {
    font-size: 1.5rem;
    color: #333;
    margin-left: 8px;
}

/* Phân bố số sao */
#rating-breakdown .list-group-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1rem;
    border: none;
}

#rating-breakdown .list-group-item span:first-child {
    display: flex;
    align-items: center;
}

/* Lọc đánh giá */
#filter-stars {
    border-radius: 5px;
    border: 1px solid #ced4da;
}

/* Danh sách đánh giá */
#review-list .list-group-item {
    border: none;
    border-bottom: 1px solid #e9ecef;
    padding: 10px 0;
}

#review-list .list-group-item:last-child {
    border: none;
}

#review-list strong {
    color: #007bff;
}

#review-list small {
    color: #6c757d;
}

#review-list .btn-danger {
    font-size: 0.8rem;
    margin-top: 5px;
}
    </style>
